@Grab(group='net.lingala.zip4j', module='zip4j', version='2.11.5')
import net.lingala.zip4j.ZipFile;

nextflow_pipeline {

    def PASSWORD = "test-password"
	def TOTAL_REFPANEL_CHR20_B37 = 63402;
	def TOTAL_REFPANEL_CHR20_B38 = 63384;
	def ONLY_IN_INPUT = 78;
	def TOTAL_SNPS_INPUT = 7824;
	def SNPS_MONOMORPHIC = 11;

    name "Test Workflow main.nf"
    script "main.nf"

    test("Should run QC-only") {

        when {
            params {
                project  = "test-job"
                build = "hg19"
                files = "$projectDir/tests/input/chr20-phased/*.vcf.gz"
                population = "eur"
                mode = "qc-only"
                refpanel_yaml = "$projectDir/tests/data/refpanels/hapmap2-chr20/cloudgene.yaml"
                output = "${outputDir}"
            }   
        }

        then {
            assert workflow.success

            def quality_control_log = file("${outputDir}/cloudgene.report.json")
            assert quality_control_log.exists()
            assert quality_control_log.text.contains("Remaining sites in total: 7,735")
       
        }

    }

    test("Should run QC-only and check statistic files") {

        when {
            params {
                project  = "test-job"
                build = "hg19"
                files = "$projectDir/tests/input/chr20-phased/*.vcf.gz"
                population = "eur"
                mode = "qc-only"
                refpanel_yaml = "$projectDir/tests/data/refpanels/hapmap2-chr20/cloudgene.yaml"
                output = "${outputDir}"
            }
        }

        then {
            assert workflow.success

            def quality_control_log = file("${outputDir}/cloudgene.report.json")
            assert quality_control_log.exists()
            assert quality_control_log.text.contains("Remaining sites in total: 7,735")
            def typed_file = file("${outputDir}/statistics/typed-only.txt")
            assert typed_file.exists()
            def snps_file = file("${outputDir}/statistics/snps-excluded.txt")
            assert snps_file.exists()
       
        }

    }
    
    test("Should run with phased data") {

        when {
            params {
                project  = "testPipelineWithPhased"
                build = "hg19"
                files = "$projectDir/tests/input/chr20-phased/*.vcf.gz"
                population = "eur"
                password = PASSWORD
                refpanel_yaml = "$projectDir/tests/data/refpanels/hapmap2-chr20/cloudgene.yaml"
                output = "${outputDir}"
                phasing = "no_phasing"
            }
        }

        then {
            assert workflow.success

            def quality_control_log = file("${outputDir}/cloudgene.report.json")
            assert quality_control_log.exists()
            assert quality_control_log.text.contains("Remaining sites in total: 7,735")

            def imputed_chr_20 = file("${outputDir}/chr_20.zip");
            assert imputed_chr_20.exists()
            ZipFile zipFile = new ZipFile(imputed_chr_20, PASSWORD.toCharArray());
            zipFile.extractAll("${outputDir}");
            def file = path("${outputDir}/chr20.dose.vcf.gz").vcf
            assert file.getChromosome() == "20"
            assert file.getNoSamples() == 51;
            assert file.isPhased()
            assert file.getNoSnps() == TOTAL_REFPANEL_CHR20_B37 + ONLY_IN_INPUT
            
            //check correct number of snps in info.gz file
            assert path("${outputDir}/chr20.info.gz").linesGzip.size() == 1 + TOTAL_REFPANEL_CHR20_B37 + ONLY_IN_INPUT

        }

    }

    test("Should run with phased data and meta option") {

        when {
            params {
                project  = "testPipelineWithPhasedAndMetaOption"
                build = "hg19"
                files = "$projectDir/tests/input/chr20-phased/*.vcf.gz"
                population = "eur"
                password = PASSWORD
                refpanel_yaml = "$projectDir/tests/data/refpanels/hapmap2-chr20/cloudgene.yaml"
                output = "${outputDir}"
                phasing = "no_phasing"
            }
        }

        then {
            assert workflow.success

            def quality_control_log = file("${outputDir}/cloudgene.report.json")
            assert quality_control_log.exists()
            assert quality_control_log.text.contains("Remaining sites in total: 7,735")

            def imputed_chr_20 = file("${outputDir}/chr_20.zip");
            assert imputed_chr_20.exists()
            ZipFile zipFile = new ZipFile(imputed_chr_20, PASSWORD.toCharArray());
            zipFile.extractAll("${outputDir}");
            def file = path("${outputDir}/chr20.dose.vcf.gz").vcf
            def fileMeta = path("${outputDir}/chr20.empiricalDose.vcf.gz").vcf
            assert fileMeta.getNoSnps() == 7735
            assert file.getChromosome() == "20"
            assert file.getNoSamples() == 51;
            assert file.isPhased()
            assert file.getNoSnps() == TOTAL_REFPANEL_CHR20_B37 + ONLY_IN_INPUT
            
            //check correct number of snps in info.gz file
            assert path("${outputDir}/chr20.info.gz").linesGzip.size() == 1 + TOTAL_REFPANEL_CHR20_B37 + ONLY_IN_INPUT

        }

    }

    test("Should run without phasing") {

        when {
            params {
                project  = "test-job"
                build = "hg19"
                files = "$projectDir/tests/input/chr20-phased/*.vcf.gz"
                population = "eur"
                phasing = "no_phasing"
                password = PASSWORD
                refpanel_yaml = "$projectDir/tests/data/refpanels/hapmap2-chr20/cloudgene.yaml"
                output = "${outputDir}"
            }
        }

        then {
            assert workflow.success

            def quality_control_log = file("${outputDir}/cloudgene.report.json")
            assert quality_control_log.exists()
            assert quality_control_log.text.contains("Remaining sites in total: 7,735")

            def imputed_chr_20 = file("${outputDir}/chr_20.zip");
            assert imputed_chr_20.exists()
            ZipFile zipFile = new ZipFile(imputed_chr_20, PASSWORD.toCharArray());
            zipFile.extractAll("${outputDir}");

            //check correct number of snps in info.gz file
            assert path("${outputDir}/chr20.info.gz").linesGzip.size() == 1 + TOTAL_REFPANEL_CHR20_B37 + ONLY_IN_INPUT

        }

    }

    test("Should run phasing-only") {

        when {
            params {
                project  = "test-job"
                build = "hg19"
                files = "$projectDir/tests/input/chr20-phased/*.vcf.gz"
                population = "eur"
                mode = "phasing_only"
                password = PASSWORD
                refpanel_yaml = "$projectDir/tests/data/refpanels/hapmap2-chr20/cloudgene.yaml"
                output = "${outputDir}"
            }
        }

        then {
            assert workflow.success

            def quality_control_log = file("${outputDir}/cloudgene.report.json")
            assert quality_control_log.exists()
            assert quality_control_log.text.contains("Remaining sites in total: 7,735")

            //TODO: add phasing only mode in workflow!
            //def imputed_chr_20 = file("${outputDir}/chr_20.zip");
            //assert imputed_chr_20.exists()
            //ZipFile zipFile = new ZipFile(imputed_chr_20, PASSWORD.toCharArray());
            //zipFile.extractAll("${outputDir}");

          

        }

    }

}